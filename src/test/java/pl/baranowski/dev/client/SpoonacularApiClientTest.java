package pl.baranowski.dev.client;

import okhttp3.mockwebserver.MockResponse;
import okhttp3.mockwebserver.MockWebServer;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import pl.baranowski.dev.exception.ExternalApiException;

import java.io.IOException;
import java.util.Arrays;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.fail;

@SpringBootTest(classes = {MockWebServer.class})
class SpoonacularApiClientTest {
    @Autowired
    MockWebServer mockWebServer;
    SpoonacularApiClient underTest;

    @BeforeEach
    void setUp() throws IOException {
        mockWebServer = new MockWebServer();
        mockWebServer.start();
        underTest = new SpoonacularApiClient(mockWebServer.url("/").toString());
    }

    @AfterEach
    void tearDown() throws IOException {
        mockWebServer.shutdown();
    }

    @Test
    void get() throws ExternalApiException {
        //given
        String expectedJSON = "{\"vegetarian\": false,\"vegan\": false,\"glutenFree\": false,\"dairyFree\": false,\"veryHealthy\": false,\"cheap\": false,\"veryPopular\": false,\"sustainable\": false,\"weightWatcherSmartPoints\": 8,\"gaps\": \"no\",\"lowFodmap\": false,\"aggregateLikes\": 4,\"spoonacularScore\": 82.0,\"healthScore\": 34.0,\"creditsText\": \"Foodista.com â€“ The Cooking Encyclopedia Everyone Can Edit\",\"license\": \"CC BY 3.0\",\"sourceName\": \"Foodista\",\"pricePerServing\": 96.25,\"extendedIngredients\": [{\"id\": 10120420,\"aisle\": \"Pasta and Rice\",\"image\": \"farfalle.png\",\"consistency\": \"solid\",\"name\": \"farfalle pasta\",\"nameClean\": \"farfalle\",\"original\": \"1 pound farfalle pasta\",\"originalName\": \"farfalle pasta\",\"amount\": 1.0,\"unit\": \"pound\",\"meta\": [],\"measures\": {\"us\": {\"amount\": 1.0,\"unitShort\": \"lb\",\"unitLong\": \"pound\"},\"metric\": {\"amount\": 453.592,\"unitShort\": \"g\",\"unitLong\": \"grams\"}}},{\"id\": 4042,\"aisle\": \"Oil, Vinegar, Salad Dressing\",\"image\": \"peanut-oil.jpg\",\"consistency\": \"liquid\",\"name\": \"peanut oil\",\"nameClean\": \"peanut oil\",\"original\": \"2 tablespoons peanut oil\",\"originalName\": \"peanut oil\",\"amount\": 2.0,\"unit\": \"tablespoons\",\"meta\": [],\"measures\": {\"us\": {\"amount\": 2.0,\"unitShort\": \"Tbsps\",\"unitLong\": \"Tbsps\"},\"metric\": {\"amount\": 2.0,\"unitShort\": \"Tbsps\",\"unitLong\": \"Tbsps\"}}},{\"id\": 11124,\"aisle\": \"Produce\",\"image\": \"sliced-carrot.png\",\"consistency\": \"solid\",\"name\": \"carrots\",\"nameClean\": \"carrot\",\"original\": \"3 carrots\",\"originalName\": \"carrots\",\"amount\": 3.0,\"unit\": \"\",\"meta\": [],\"measures\": {\"us\": {\"amount\": 3.0,\"unitShort\": \"\",\"unitLong\": \"\"},\"metric\": {\"amount\": 3.0,\"unitShort\": \"\",\"unitLong\": \"\"}}},{\"id\": 11090,\"aisle\": \"Produce\",\"image\": \"broccoli.jpg\",\"consistency\": \"solid\",\"name\": \"broccoli\",\"nameClean\": \"broccoli\",\"original\": \"2 inches large broccoli heads (that's what she said)\",\"originalName\": \"broccoli heads (that's what she said)\",\"amount\": 2.0,\"unit\": \"inches\",\"meta\": [\"(that's what she said)\"],\"measures\": {\"us\": {\"amount\": 2.0,\"unitShort\": \"inches\",\"unitLong\": \"inches\"},\"metric\": {\"amount\": 2.0,\"unitShort\": \"inches\",\"unitLong\": \"inches\"}}},{\"id\": 11291,\"aisle\": \"Produce\",\"image\": \"spring-onions.jpg\",\"consistency\": \"solid\",\"name\": \"scallions\",\"nameClean\": \"spring onions\",\"original\": \"2 bunches of scallions\",\"originalName\": \"scallions\",\"amount\": 2.0,\"unit\": \"bunches\",\"meta\": [],\"measures\": {\"us\": {\"amount\": 2.0,\"unitShort\": \"bunches\",\"unitLong\": \"bunches\"},\"metric\": {\"amount\": 2.0,\"unitShort\": \"bunches\",\"unitLong\": \"bunches\"}}},{\"id\": 11215,\"aisle\": \"Produce\",\"image\": \"garlic.png\",\"consistency\": \"solid\",\"name\": \"garlic cloves\",\"nameClean\": \"garlic\",\"original\": \"3 garlic cloves, minced\",\"originalName\": \"garlic cloves, minced\",\"amount\": 3.0,\"unit\": \"\",\"meta\": [\"minced\"],\"measures\": {\"us\": {\"amount\": 3.0,\"unitShort\": \"\",\"unitLong\": \"\"},\"metric\": {\"amount\": 3.0,\"unitShort\": \"\",\"unitLong\": \"\"}}},{\"id\": 1033,\"aisle\": \"Cheese\",\"image\": \"parmesan.jpg\",\"consistency\": \"solid\",\"name\": \"parmigiano reggiano\",\"nameClean\": \"parmesan\",\"original\": \"1 cup + of Parmigiano-Reggiano, grated\",\"originalName\": \"of Parmigiano-Reggiano, grated\",\"amount\": 1.0,\"unit\": \"cup\",\"meta\": [\"grated\"],\"measures\": {\"us\": {\"amount\": 1.0,\"unitShort\": \"cup\",\"unitLong\": \"cup\"},\"metric\": {\"amount\": 236.588,\"unitShort\": \"ml\",\"unitLong\": \"milliliters\"}}},{\"id\": 10111529,\"aisle\": \"Produce\",\"image\": \"cherry-tomatoes.png\",\"consistency\": \"solid\",\"name\": \"grape tomatoes\",\"nameClean\": \"grape tomato\",\"original\": \"1 container grape tomatoes\",\"originalName\": \"grape tomatoes\",\"amount\": 1.0,\"unit\": \"container\",\"meta\": [],\"measures\": {\"us\": {\"amount\": 1.0,\"unitShort\": \"container\",\"unitLong\": \"container\"},\"metric\": {\"amount\": 1.0,\"unitShort\": \"container\",\"unitLong\": \"container\"}}}],\"id\": 642582,\"title\": \"Farfalle With Broccoli, Carrots and Tomatoes\",\"readyInMinutes\": 45,\"servings\": 8,\"sourceUrl\": \"https://www.foodista.com/recipe/YV88GS5Z/farfalle-with-broccoli-carrots-and-tomatoes\",\"image\": \"https://spoonacular.com/recipeImages/642582-556x370.jpg\",\"imageType\": \"jpg\",\"summary\": \"Farfalle With Broccoli, Carrots and Tomatoes requires about <b>about 45 minutes</b> from start to finish. This recipe serves 8. For <b>96 cents per serving</b>, this recipe <b>covers 15%</b> of your daily requirements of vitamins and minerals. One portion of this dish contains around <b>13g of protein</b>, <b>8g of fat</b>, and a total of <b>309 calories</b>. 4 people have tried and liked this recipe. This recipe from Foodista requires grape tomatoes, parmigiano-reggiano, carrots, and garlic cloves. It works well as a very budget friendly main course. All things considered, we decided this recipe <b>deserves a spoonacular score of 82%</b>. This score is great. Similar recipes include <a href=\\\"https://spoonacular.com/recipes/farfalle-with-tomatoes-and-feta-cheese-108238\\\">Farfalle with Tomatoes and Feta Cheese</a>, <a href=\\\"https://spoonacular.com/recipes/farfalle-with-sausage-tomatoes-and-cream-106954\\\">Farfalle with Sausage, Tomatoes, and Cream</a>, and <a href=\\\"https://spoonacular.com/recipes/farfalle-with-tomatoes-onions-and-spinach-303899\\\">Farfalle with Tomatoes, Onions, and Spinach</a>.\",\"cuisines\": [],\"dishTypes\": [\"side dish\",\"lunch\",\"main course\",\"main dish\",\"dinner\"],\"diets\": [],\"occasions\": [],\"winePairing\": {\"pairedWines\": [],\"pairingText\": \"\",\"productMatches\": []},\"instructions\": \"Bring a large pot of water to boil\\nCook pasta about one or two minutes less than recommended on package directions.\\nClean and slice the carrots into thin rounds\\nCut the broccoli into small florets\\nRoughly dice the stalks\\nThinly slice the green onions\\nHeat the peanut oil in a skillet over medium-high heat\\nAdd minced garlic and saute for about 30 seconds\\nAdd broccoli and carrots, and cook 3-5 minutes until the vegetables are softened but are still crisp\\nAdd the scallions and cook for another 30 seconds\\nSeason well with salt and remove from heat.\\nMix the vegetables and the pasta, let cool T\\nThen add tomatoes and cheese (note: if cooking ahead of time, wait to add the tomatoes and cheese until about an hour before serving).\",\"analyzedInstructions\": [{\"name\": \"\",\"steps\": [{\"number\": 1,\"step\": \"Bring a large pot of water to boil\",\"ingredients\": [{\"id\": 14412,\"name\": \"water\",\"localizedName\": \"water\",\"image\": \"water.png\"}],\"equipment\": [{\"id\": 404752,\"name\": \"pot\",\"localizedName\": \"pot\",\"image\": \"stock-pot.jpg\"}]},{\"number\": 2,\"step\": \"Cook pasta about one or two minutes less than recommended on package directions.\",\"ingredients\": [{\"id\": 20420,\"name\": \"pasta\",\"localizedName\": \"pasta\",\"image\": \"fusilli.jpg\"}],\"equipment\": [],\"length\": {\"number\": 2,\"unit\": \"minutes\"}},{\"number\": 3,\"step\": \"Clean and slice the carrots into thin rounds\",\"ingredients\": [{\"id\": 11124,\"name\": \"carrot\",\"localizedName\": \"carrot\",\"image\": \"sliced-carrot.png\"}],\"equipment\": []},{\"number\": 4,\"step\": \"Cut the broccoli into small florets\",\"ingredients\": [{\"id\": 11090,\"name\": \"broccoli\",\"localizedName\": \"broccoli\",\"image\": \"broccoli.jpg\"}],\"equipment\": []},{\"number\": 5,\"step\": \"Roughly dice the stalks\",\"ingredients\": [],\"equipment\": []},{\"number\": 6,\"step\": \"Thinly slice the green onions\",\"ingredients\": [{\"id\": 11291,\"name\": \"green onions\",\"localizedName\": \"green onions\",\"image\": \"spring-onions.jpg\"}],\"equipment\": []},{\"number\": 7,\"step\": \"Heat the peanut oil in a skillet over medium-high heat\",\"ingredients\": [{\"id\": 4042,\"name\": \"peanut oil\",\"localizedName\": \"peanut oil\",\"image\": \"peanut-oil.jpg\"}],\"equipment\": [{\"id\": 404645,\"name\": \"frying pan\",\"localizedName\": \"frying pan\",\"image\": \"pan.png\"}]},{\"number\": 8,\"step\": \"Add minced garlic and saute for about 30 seconds\",\"ingredients\": [{\"id\": 0,\"name\": \"minced garlic\",\"localizedName\": \"minced garlic\",\"image\": \"garlic.png\"}],\"equipment\": []},{\"number\": 9,\"step\": \"Add broccoli and carrots, and cook 3-5 minutes until the vegetables are softened but are still crisp\",\"ingredients\": [{\"id\": 11583,\"name\": \"vegetable\",\"localizedName\": \"vegetable\",\"image\": \"mixed-vegetables.png\"},{\"id\": 11090,\"name\": \"broccoli\",\"localizedName\": \"broccoli\",\"image\": \"broccoli.jpg\"},{\"id\": 11124,\"name\": \"carrot\",\"localizedName\": \"carrot\",\"image\": \"sliced-carrot.png\"}],\"equipment\": [],\"length\": {\"number\": 5,\"unit\": \"minutes\"}},{\"number\": 10,\"step\": \"Add the scallions and cook for another 30 seconds\",\"ingredients\": [{\"id\": 11291,\"name\": \"green onions\",\"localizedName\": \"green onions\",\"image\": \"spring-onions.jpg\"}],\"equipment\": []},{\"number\": 11,\"step\": \"Season well with salt and remove from heat.\",\"ingredients\": [{\"id\": 2047,\"name\": \"salt\",\"localizedName\": \"salt\",\"image\": \"salt.jpg\"}],\"equipment\": []},{\"number\": 12,\"step\": \"Mix the vegetables and the pasta, let cool T\",\"ingredients\": [{\"id\": 11583,\"name\": \"vegetable\",\"localizedName\": \"vegetable\",\"image\": \"mixed-vegetables.png\"},{\"id\": 20420,\"name\": \"pasta\",\"localizedName\": \"pasta\",\"image\": \"fusilli.jpg\"}],\"equipment\": []},{\"number\": 13,\"step\": \"Then add tomatoes and cheese (note: if cooking ahead of time, wait to add the tomatoes and cheese until about an hour before serving).\",\"ingredients\": [{\"id\": 11529,\"name\": \"tomato\",\"localizedName\": \"tomato\",\"image\": \"tomato.png\"},{\"id\": 1041009,\"name\": \"cheese\",\"localizedName\": \"cheese\",\"image\": \"cheddar-cheese.png\"}],\"equipment\": []}]}],\"originalId\": null,\"spoonacularSourceUrl\": \"https://spoonacular.com/farfalle-with-broccoli-carrots-and-tomatoes-642582\"}";
        MockResponse mockedResponse = new MockResponse().setBody(expectedJSON).addHeader("Content-Type", "application/json");
        mockWebServer.enqueue(mockedResponse);
        //when
        String response = underTest.get(1L);
        //then
        assertEquals(expectedJSON, response);
    }
    @Test
    void find() throws ExternalApiException {
        //given
        String expectedJSON = "{\"results\":[{\"id\":645479,\"usedIngredientCount\":2,\"missedIngredientCount\":4,\"missedIngredients\":[{\"id\":93607,\"amount\":1.5,\"unit\":\"cup\",\"unitLong\":\"cups\",\"unitShort\":\"cup\",\"aisle\":\"Milk,Eggs,OtherDairy\",\"name\":\"almondmilk\",\"original\":\"11/2cupunsweetenedalmondmilk\",\"originalName\":\"unsweetenedalmondmilk\",\"meta\":[\"unsweetened\"],\"extendedName\":\"unsweetenedalmondmilk\",\"image\":\"https://spoonacular.com/cdn/ingredients_100x100/almond-milk.png\"},{\"id\":11457,\"amount\":2.0,\"unit\":\"cups\",\"unitLong\":\"cups\",\"unitShort\":\"cup\",\"aisle\":\"Produce\",\"name\":\"babyspinach\",\"original\":\"2cupsbabyspinach\",\"originalName\":\"babyspinach\",\"meta\":[],\"image\":\"https://spoonacular.com/cdn/ingredients_100x100/spinach.jpg\"},{\"id\":19296,\"amount\":1.0,\"unit\":\"tablespoon\",\"unitLong\":\"tablespoon\",\"unitShort\":\"Tbsp\",\"aisle\":\"Nutbutters,Jams,andHoney\",\"name\":\"honey\",\"original\":\"1tablespoonhoney\",\"originalName\":\"honey\",\"meta\":[],\"image\":\"https://spoonacular.com/cdn/ingredients_100x100/honey.png\"},{\"id\":9176,\"amount\":1.0,\"unit\":\"cup\",\"unitLong\":\"cup\",\"unitShort\":\"cup\",\"aisle\":\"Produce\",\"name\":\"mango\",\"original\":\"1cupmango,freshorfrozen\",\"originalName\":\"mango,freshorfrozen\",\"meta\":[\"fresh\"],\"extendedName\":\"freshmango\",\"image\":\"https://spoonacular.com/cdn/ingredients_100x100/mango.jpg\"}],\"usedIngredients\":[{\"id\":9037,\"amount\":1.0,\"unit\":\"\",\"unitLong\":\"\",\"unitShort\":\"\",\"aisle\":\"Produce\",\"name\":\"avocado\",\"original\":\"1avocado\",\"originalName\":\"avocado\",\"meta\":[],\"image\":\"https://spoonacular.com/cdn/ingredients_100x100/avocado.jpg\"},{\"id\":9040,\"amount\":1.0,\"unit\":\"\",\"unitLong\":\"\",\"unitShort\":\"\",\"aisle\":\"Produce\",\"name\":\"banana\",\"original\":\"1banana\",\"originalName\":\"banana\",\"meta\":[],\"image\":\"https://spoonacular.com/cdn/ingredients_100x100/bananas.jpg\"}],\"unusedIngredients\":[],\"likes\":0,\"title\":\"GreenMonsterIcePops\",\"image\":\"https://spoonacular.com/recipeImages/645479-312x231.jpg\",\"imageType\":\"jpg\"},{\"id\":634048,\"usedIngredientCount\":2,\"missedIngredientCount\":2,\"missedIngredients\":[{\"id\":19165,\"amount\":0.3333333333333333,\"unit\":\"cup\",\"unitLong\":\"cups\",\"unitShort\":\"cup\",\"aisle\":\"Baking\",\"name\":\"cocoapowder\",\"original\":\"1/3cupcocoapowder\",\"originalName\":\"cocoapowder\",\"meta\":[],\"image\":\"https://spoonacular.com/cdn/ingredients_100x100/cocoa-powder.png\"},{\"id\":16098,\"amount\":0.5,\"unit\":\"cup\",\"unitLong\":\"cups\",\"unitShort\":\"cup\",\"aisle\":\"Nutbutters,Jams,andHoney\",\"name\":\"peanutbutter\",\"original\":\"1/2cuppeanutbutter\",\"originalName\":\"peanutbutter\",\"meta\":[],\"image\":\"https://spoonacular.com/cdn/ingredients_100x100/peanut-butter.png\"}],\"usedIngredients\":[{\"id\":9037,\"amount\":1.0,\"unit\":\"\",\"unitLong\":\"\",\"unitShort\":\"\",\"aisle\":\"Produce\",\"name\":\"avocado\",\"original\":\"1ripeavocado\",\"originalName\":\"ripeavocado\",\"meta\":[\"ripe\"],\"image\":\"https://spoonacular.com/cdn/ingredients_100x100/avocado.jpg\"},{\"id\":9040,\"amount\":4.0,\"unit\":\"\",\"unitLong\":\"\",\"unitShort\":\"\",\"aisle\":\"Produce\",\"name\":\"bananas\",\"original\":\"4-5ripebananas\",\"originalName\":\"ripebananas\",\"meta\":[\"ripe\"],\"image\":\"https://spoonacular.com/cdn/ingredients_100x100/bananas.jpg\"}],\"unusedIngredients\":[],\"likes\":0,\"title\":\"BananaChocolatePudding\",\"image\":\"https://spoonacular.com/recipeImages/634048-312x231.jpg\",\"imageType\":\"jpg\"}],\"offset\":0,\"number\":10,\"totalResults\":2}";
        MockResponse mockedResponse = new MockResponse().setBody(expectedJSON).addHeader("Content-Type", "application/json");
        mockWebServer.enqueue(mockedResponse);
        //when
        String result = underTest.find(Arrays.asList("banana", "avocado"), Arrays.asList("onion", "strawberry"));
        //then
        assertEquals(expectedJSON, result);
    }
}